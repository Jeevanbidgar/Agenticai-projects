# Auth Vulnerability Tester

A Python-based automation tool for testing pre-authentication account takeover vulnerabilities in web applications. This tool simulates attack scenarios where malicious actors pre-register accounts with target email addresses before legitimate users perform SSO registration.

## Overview

The tool tests for a critical vulnerability pattern:

1. **Attacker** creates a password-based account with victim's email
2. **Victim** later registers using SSO (Google) with the same email
3. **Vulnerability**: If the attacker can still log in with the original password after SSO registration, account takeover is possible

## Project Architecture

### Technology Stack

- **Python 3.10+** - Core language
- **LangGraph** - State management and workflow orchestration
- **Playwright** - Browser automation with anti-bot evasion
- **MailSlurp** - Disposable email inbox for verification
- **Loguru** - Structured logging
- **Pydantic** - Data validation and state management

### Workflow Orchestration

The tool uses a 9-node LangGraph workflow:

```
discover_pages → dismiss_cookies → detect_sso_buttons →
password_signup → email_verification → google_sso_register →
password_login_check → analyze_vulnerability → report_results
```

## Development Phases

### Phase 1: Project Foundation ✅

**Goal**: Establish project structure, dependencies, and CLI interface

**Deliverables**:

- Complete project directory structure with modular organization
- `requirements.txt` with all necessary dependencies
- CLI interface using Click with comprehensive option handling
- Configuration system with YAML support and domain-specific overrides
- Pydantic `TestState` model for workflow state management
- Environment variable management with `.env` support
- Logging infrastructure using Loguru
- LangGraph workflow skeleton with 9-node structure

**Key Features Implemented**:

- eTLD+1 domain matching for site-specific configurations
- Timestamped results directory structure
- Email/password resolution with CLI override priority
- Legal consent notice and permission validation
- Proxy URL format validation
- Browser channel preference (Chrome → Chromium fallback)

### Phase 2: Browser Automation Foundation ✅

**Goal**: Implement comprehensive Playwright browser management with persistent sessions

**Deliverables**:

- `BrowserManager` class with async context management
- Persistent Google profile for session reuse (`.cache/google_profile`)
- Anti-bot evasion techniques (locale, timezone, User-Agent randomization)
- Evidence collection system (screenshots, HTML dumps, storage snapshots)
- Cookie banner auto-dismissal
- Human behavior simulation (typing delays, mouse movements)
- Auto-installation of Playwright browsers
- HAR network trace capture (optional)

**Key Features Implemented**:

- Chrome DevTools Protocol (CDP) integration for attaching to existing browsers
- Fresh incognito contexts for target site testing
- Google session bootstrap with risk check handling
- Comprehensive error handling with graceful degradation
- Storage management (cookies, localStorage, sessionStorage)
- Performance metrics collection
- Browser setup validation

**Advanced Capabilities**:

- Automatic Google login with manual verification support
- Session persistence across test runs
- Proxy support for target sites (excluding Google auth)
- Randomized viewport sizes and user agents
- Console log capture and correlation

### Phase 3: Async Workflow Implementation ✅

**Goal**: Convert LangGraph nodes to async operations with state persistence

**Deliverables**:

- Async-converted LangGraph workflow nodes
- Checkpointing system for workflow resume capability
- MailSlurp integration for automated email verification
- Enhanced evidence collection at each workflow step
- Performance metrics tracking per node
- Conditional routing based on verification requirements

**Key Features Implemented**:

- Single browser session management across all nodes
- Before/after evidence capture for each step
- Email inbox auto-creation when email not provided
- Storage snapshot comparison for vulnerability detection
- Console log aggregation with per-step granularity
- Resume functionality from any completed node
- Performance timing collection (navigation, DOM ready, resource loading)

**Workflow Enhancements**:

- Smart waiting strategies for SPA applications
- OAuth popup handling with account auto-selection
- Email verification with link extraction and code support
- Fresh attacker context simulation for password login testing

### Phase 4: Vulnerability Testing Implementation ✅

**Goal**: Complete end-to-end vulnerability detection with advanced analysis

**Deliverables**:

- Advanced SSO provider detection and cataloging
- Intelligent form field inference with fallbacks
- OAuth flow management with consent handling
- Comprehensive vulnerability scoring rubric
- Enhanced error handling and retry mechanisms
- Real-world scenario adaptation

**Key Features Implemented**:

- **SSO Provider Cataloging**: Detect Google, Apple, Facebook, Microsoft, GitHub, Twitter (testing Google only)
- **Smart Form Handling**: Automatic field detection with CSS/name-based fallbacks
- **OAuth Flow Management**: Complete Google OAuth with popup handling, account selection, consent screens
- **Vulnerability Scoring**: 4-tier rubric (High/Medium/Low/None) with detailed rationale
- **Evidence Correlation**: Storage diffs, account identifier extraction, session analysis
- **Anti-Bot Evasion**: Human-like delays, randomized interactions, browser fingerprinting resistance

**Accuracy & Reliability Enhancements**:

- **Preflight Validation**: Validates site config selectors (`email_field`, `password_field`, `submit_button`, `account_identifier`) before starting. Optional hard fail with `--fail-on-preflight`.
- **Absolute URL Resolution**: All configured/discovered paths are resolved against base `--url` to avoid relative navigation issues.
- **SPA/Lazy-Loaded SSO Detection**: Short hydration wait and DOM re-scan to catch buttons that appear post-render.
- **Attacker Session Hygiene**: Fresh context plus best-effort service worker unregister before password login.
- **OAuth Redirect Tracing**: Captures OAuth-related responses/redirects even without HAR (in attached Chrome mode).

**Advanced Analysis**:

- Account linking detection and behavior analysis
- Cross-domain session state tracking
- Authentication token comparison
- Performance impact measurement
- Comprehensive audit trail with evidence correlation

### Phase 5: Evidence Collection and Reporting ✅

**Goal**: Build comprehensive evidence collection and professional reporting.

**Deliverables**:

- `utils/evidence.py` orchestrator for screenshots, HTML dumps, cookie dumps, network logs, and validation
- `reporters/report_generator.py` (Jinja2-capable) generating Markdown + JSON (schema `v1`)
- Evidence Timeline in Markdown with embedded screenshots (relative paths)
- Network logging to `evidence/network.jsonl` when HAR is disabled, with summary in report
- CVSS-like scoring derived from rubric (vector + numeric score) and remediation guidance
- `utils/gmail_helper.py` to monitor Gmail and auto-click verification links (fallback when MailSlurp not used)
- Evidence validation output at `evidence/validation.json`

**Key Features Implemented**:

- Centralized `capture_step(...)` used across nodes to build a unified evidence trail
- Automatic network logging via `page` events; headers/tokens redacted when `--redact-pii`
- Template-based Markdown with thumbnails; stable JSON schema for programmatic use
- Report generator fallback template if no filesystem templates are present

## Usage

### Basic Command

```bash
python main.py --url https://example.com --i-have-permission
```

### Advanced Usage

```bash
python main.py \
  --url https://target-site.com \
  --email test@temp.com \
  --password TestPass123 \
  --headed \
  --save-har \
  --slowmo 500 \
  --proxy http://proxy:8080 \
  --fail-on-preflight \
  --i-have-permission
```

### Environment Setup

Create `.env` file:

```env
MAILSLURP_API_KEY=your_api_key_here
GOOGLE_TEST_EMAIL=test@gmail.com
GOOGLE_TEST_PASSWORD=your_password
```

**Important**: Disable 2FA on `GOOGLE_TEST_EMAIL` for automated testing.

If `--email` is not provided, an inbox is auto-created via MailSlurp and used for verification. If you provide an email and it is a MailSlurp address, the flow will still be fully automated.

### Site Configuration

Create `config/sites/yoursite.com.yaml`:

```yaml
login_url: "/login"
signup_url: "/register"
account_identifier: ".user-email, [data-testid='user-email']"
email_field: "input[name='email'], #email"
password_field: "input[name='password'], #password"
submit_button: "button[type='submit']"
sso_google:
  - "button:has-text('Sign in with Google')"
  - "[data-provider='google']"
```

## Output Structure

Each test run creates a timestamped directory:

```
results/2024-01-15_14-30-25_example.com/
├── report.json              # Machine-readable results
├── summary.md              # Human-readable analysis
├── storage.json            # Browser storage snapshots
├── network_trace.har       # Network trace (if --save-har)
├── console.log            # Browser console output
├── checkpoints/           # Workflow state saves
│   ├── discover_pages.json
│   └── ...
└── screenshots/           # Evidence collection
    ├── 01_initial_page.png
    ├── 02_cookie_dismissed.png
    ├── 03_signup_form.png
    └── ...
evidence/
  ├── network.jsonl          # Request/response logs (when HAR disabled)
  └── validation.json        # Evidence validation summary
```

### Evidence Details

- `storage.json`: Persisted storage snapshots (after signup/SSO/login)
- `console.log`: Rolling browser console logs
- OAuth redirects: Captured in-run and included in JSON report under `oauth_redirects`
- `evidence/network.jsonl`: Structured request/response stream (URL, method, status, headers)
- `evidence/validation.json`: Minimal checks for screenshots/HTML/network presence
- Reports generated by ReportGenerator: Markdown summary and JSON schema `v1` (with CVSS-like scoring and remediation)

## Vulnerability Analysis

### Scoring Rubric

- **High**: Password login succeeds after SSO with same identifier, no email verification required
- **Medium**: Password login succeeds after SSO but email verification was required
- **Low**: Evidence of account linking but no successful attacker login
- **None**: No evidence of vulnerability or blocked by verification

### Detection Logic

1. **Account Creation**: Password-based signup with test email
2. **Email Verification**: Automated verification using MailSlurp
3. **SSO Registration**: Google OAuth with same email address
4. **Identity Comparison**: Extract account identifiers from both flows
5. **Takeover Test**: Fresh session password login attempt
6. **Vulnerability Assessment**: Compare authentication states and access levels

## Advanced Features

### Browser Session Management

- **Persistent Google Profile**: Reuse authenticated sessions to avoid repeated logins
- **CDP Integration**: Attach to existing Chrome instances for session continuity
- **Fresh Contexts**: Isolated environments for accurate attack simulation
- **Anti-Bot Measures**: Human-like behavior, randomized fingerprints, proxy support

### Evidence Collection

- **Screenshots**: Full-page captures at each workflow step
- **Storage Snapshots**: Complete browser state (cookies, localStorage, sessionStorage)
- **Network Traces**: HAR files for OAuth flow analysis
- **Performance Metrics**: Page load times, resource timings, navigation events
- **Console Logs**: JavaScript errors and application debug output

### Error Handling

- **Graceful Degradation**: Continue testing even with non-critical failures
- **Retry Logic**: Exponential backoff for transient failures
- **Checkpointing**: Resume from any workflow node after failures
- **Comprehensive Logging**: Structured error tracking with correlation IDs
- **Preflight Fail Fast**: Use `--fail-on-preflight` to stop early when required site selectors are missing

## Security Considerations

### Legal Compliance

- **Explicit Permission Required**: Use `--i-have-permission` flag
- **Responsible Disclosure**: Report findings through proper channels
- **Scope Limitation**: Test only applications you own or have authorization to test

### Operational Security

- **Credential Management**: Store test credentials securely in environment variables
- **PII Handling**: Optional redaction with `--redact-pii` flag
- **Session Isolation**: Fresh contexts prevent cross-contamination
- **Evidence Retention**: Secure storage of test artifacts and results

## Troubleshooting

### Common Issues

1. **Browser Installation**: Run `playwright install chromium` if browsers missing
2. **Google Authentication**: Ensure 2FA disabled on test account
3. **Site-Specific Selectors**: Create custom config for non-standard sites
4. **Network Issues**: Use `--proxy` for corporate environments
5. **Performance**: Adjust `--slowmo` for reliability vs speed trade-offs
6. **Preflight Failures**: Provide `email_field`, `password_field`, `submit_button`, and `account_identifier` in `config/sites/<domain>.yaml` or remove `--fail-on-preflight`

### Debug Mode

```bash
python main.py --url https://example.com --headed --slowmo 1000 --save-har --i-have-permission
```

## Contributing

This tool is designed for security professionals and developers testing their own applications. When extending functionality:

1. **Maintain Evidence Integrity**: Ensure all new features preserve audit trails
2. **Follow Async Patterns**: Use async/await for all browser operations
3. **Error Handling**: Implement graceful degradation for new features
4. **Documentation**: Update configurations and examples for new capabilities

## License

This tool is intended for authorized security testing only. Users are responsible for ensuring they have proper permission before testing any applications.
